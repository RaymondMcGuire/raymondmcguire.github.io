<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>å›´ä½ç¥ç»å–µ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0d1117;color:#e6edf3;font-family:'Segoe UI',sans-serif;min-height:100vh}
.screen{display:none}.screen.on{display:flex}

#lobby{min-height:100vh;align-items:center;justify-content:center;padding:16px;flex-direction:column;gap:12px}
.card{background:#161b22;border:1px solid #30363d;border-radius:20px;padding:34px 30px;max-width:400px;width:100%;text-align:center;box-shadow:0 24px 80px rgba(0,0,0,.6)}
.emoji{font-size:58px;line-height:1}
h1{font-size:24px;margin:10px 0 4px;font-weight:700}
.sub{color:#7d8590;font-size:13px;margin-bottom:22px}

.btn{display:block;width:100%;padding:13px;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;transition:opacity .2s;margin-bottom:10px}
.btn:disabled{opacity:.45;cursor:not-allowed}
.btn-red{background:linear-gradient(135deg,#da3633,#b91c1c);color:#fff}
.btn-grn{padding:12px 18px;background:linear-gradient(135deg,#238636,#196127);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;white-space:nowrap}

.join-row{display:flex;gap:8px;margin-bottom:6px}
.join-row input{flex:1;padding:12px 14px;background:#0d1117;color:#e6edf3;border:1px solid #30363d;border-radius:12px;font-size:18px;outline:none;text-align:center;letter-spacing:5px;text-transform:uppercase}
.join-row input:focus{border-color:#58a6ff}

.err{color:#f85149;font-size:13px;min-height:18px;margin:2px 0 6px;word-break:break-all}
.info{color:#7d8590;font-size:12px;margin-bottom:10px;line-height:1.5}

#waitBox{display:none;background:#0d1117;border:1px solid #3fb950;border-radius:12px;padding:14px;margin-bottom:12px}
#waitBox .wt{color:#3fb950;font-weight:700;font-size:13px;margin-bottom:6px}
#waitCode{color:#e6edf3;font-size:30px;font-weight:800;letter-spacing:8px;margin-bottom:4px}
#waitBox small{color:#7d8590;font-size:12px}

.rules{background:#0d1117;border:1px solid #21262d;border-radius:12px;padding:13px 15px;text-align:left;margin-top:6px}
.rules b.t{color:#58a6ff;font-size:13px}
.rules p{color:#7d8590;font-size:12.5px;line-height:1.75;margin-top:5px}

/* GAME */
#game{flex-direction:column;align-items:center;padding:14px 10px;min-height:100vh}
.ghdr{display:flex;align-items:center;gap:8px;width:100%;max-width:440px;margin-bottom:10px}
.ghdr-info{flex:1}.ghdr-info h2{font-size:17px;font-weight:700}
.ghdr-info p{color:#7d8590;font-size:12px;margin-top:1px}
.sbar{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:9px 18px;margin-bottom:12px;text-align:center;width:100%;max-width:440px}
.sbar p{font-size:14px;font-weight:600}
#board{position:relative;flex-shrink:0}
.cell{position:absolute;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0;user-select:none;transition:background .1s,box-shadow .1s}
.empty{background:#1c2128}.edge{background:#161b22;border:1px solid #21262d}
.blk{background:#6e1a1a;border:1px solid #da3633}
.cat{background:#3b2a00;border:2px solid #f0883e;box-shadow:0 0 12px rgba(240,136,62,.65);font-size:18px}
.vm{background:#0d2818;border:2px solid #3fb950;box-shadow:0 0 7px rgba(63,185,80,.4);cursor:pointer}
.clk{cursor:pointer}
.legend{display:flex;gap:14px;margin-top:12px;font-size:11px;color:#7d8590;flex-wrap:wrap;justify-content:center}
.ld{display:flex;align-items:center;gap:4px}
.ldot{display:inline-block;width:12px;height:12px;border-radius:50%}
.btn-sm{padding:7px 13px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600}
.btn-home{background:#21262d;color:#e6edf3;border:1px solid #30363d}
.btn-rst{background:#238636;color:#fff;display:none}
.badge{font-size:10px;padding:2px 7px;border-radius:20px;font-weight:700;vertical-align:middle;margin-left:4px}
.b-on{background:#0d2818;color:#3fb950}.b-off{background:#2d1b1b;color:#f85149}.b-wait{background:#1c2210;color:#f0883e}

/* action buttons */
.action-btns{display:flex;gap:8px;margin-bottom:12px;max-width:440px;width:100%}
.btn-action{flex:1;padding:12px;border:2px solid #30363d;border-radius:10px;background:#161b22;color:#e6edf3;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s}
.btn-action:disabled{opacity:.4;cursor:not-allowed}
.btn-action.active{background:#238636;border-color:#3fb950;color:#fff;box-shadow:0 0 12px rgba(63,185,80,.4)}
.btn-action:not(:disabled):hover{border-color:#58a6ff}

/* dual cats */
.cat1{background:#3b2a00;border:2px solid #f0883e;box-shadow:0 0 12px rgba(240,136,62,.65)}
.cat2{background:#1a2b3b;border:2px solid #58a6ff;box-shadow:0 0 12px rgba(88,166,255,.65)}

/* block highlight */
.vb{background:#2d1f10;border:2px solid #f0883e;box-shadow:0 0 7px rgba(240,136,62,.4);cursor:pointer}

/* spinner */
.spin{display:inline-block;width:14px;height:14px;border:2px solid #7d8590;border-top-color:#e6edf3;border-radius:50%;animation:sp .7s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes sp{to{transform:rotate(360deg)}}

/* ğŸ± CAT ANIMATIONS */
.cat{animation:catBreathe 2s ease-in-out infinite;transition:all .3s cubic-bezier(.4,0,.2,1)!important}
.cat:hover{animation:catWiggle .5s ease-in-out infinite;transform:scale(1.15)}
@keyframes catBreathe{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
@keyframes catWiggle{0%,100%{transform:rotate(-5deg) scale(1.15)}50%{transform:rotate(5deg) scale(1.15)}}

/* cat position transition */
.cat.moving{animation:catJump .4s ease-out}
@keyframes catJump{0%{transform:scale(1) translateY(0)}30%{transform:scale(1.2) translateY(-8px) rotate(10deg)}60%{transform:scale(0.95) translateY(0) rotate(-5deg)}100%{transform:scale(1) translateY(0) rotate(0)}}

/* ğŸ¨ ENHANCED VISUALS */
body{background:linear-gradient(135deg,#0d1117 0%,#1a1f2e 50%,#0d1117 100%)}

.card{background:linear-gradient(145deg,#1a1f2e,#161b22);border:1px solid #30363d;box-shadow:0 30px 90px rgba(0,0,0,.7),0 0 1px rgba(255,255,255,.1) inset}

/* glassmorphism buttons */
.btn-action{background:rgba(22,27,34,.8);backdrop-filter:blur(10px);border:1px solid rgba(48,54,61,.6);box-shadow:0 4px 15px rgba(0,0,0,.3)}
.btn-action:not(:disabled):hover{background:rgba(30,35,45,.9);border-color:#58a6ff;box-shadow:0 6px 20px rgba(88,166,255,.2),0 0 20px rgba(88,166,255,.1)}
.btn-action.active{background:linear-gradient(135deg,rgba(35,134,54,.95),rgba(25,97,39,.95));border-color:#3fb950;box-shadow:0 0 25px rgba(63,185,80,.5),0 4px 15px rgba(35,134,54,.4)}

/* enhanced cells */
.empty{background:radial-gradient(circle at 30% 30%,#22272e,#1c2128);border:1px solid rgba(33,38,45,.4)}
.edge{background:linear-gradient(135deg,#1a1f2a,#161b22);border:1px solid #30363d;box-shadow:0 0 5px rgba(88,166,255,.1) inset}
.blk{background:radial-gradient(circle at 30% 30%,#8b2020,#6e1a1a);border:1px solid #da3633;box-shadow:0 0 10px rgba(218,54,51,.3)}

/* enhanced highlights */
.vm{background:radial-gradient(circle at 30% 30%,#15402a,#0d2818);border:2px solid #3fb950;box-shadow:0 0 15px rgba(63,185,80,.6),0 0 5px rgba(63,185,80,.3) inset;animation:pulse .8s ease-in-out infinite}
.vb{background:radial-gradient(circle at 30% 30%,#4a3010,#2d1f10);border:2px solid #f0883e;box-shadow:0 0 15px rgba(240,136,62,.6),0 0 5px rgba(240,136,62,.3) inset;animation:pulse .8s ease-in-out infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 15px rgba(63,185,80,.6),0 0 5px rgba(63,185,80,.3) inset}50%{box-shadow:0 0 25px rgba(63,185,80,.9),0 0 10px rgba(63,185,80,.5) inset}}

/* enhanced cat styles */
.cat1{background:radial-gradient(circle at 30% 30%,#5a4000,#3b2a00);border:2px solid #f0883e;box-shadow:0 0 20px rgba(240,136,62,.8),0 0 8px rgba(240,136,62,.4) inset}
.cat2{background:radial-gradient(circle at 30% 30%,#2a4a6b,#1a2b3b);border:2px solid #58a6ff;box-shadow:0 0 20px rgba(88,166,255,.8),0 0 8px rgba(88,166,255,.4) inset}

/* ğŸ† VICTORY CONFETTI */
.confetti{position:fixed;width:10px;height:10px;background:#f0883e;position:absolute;animation:confettiFall 3s linear forwards}
@keyframes confettiFall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* rematch button */
.btn-rematch{background:linear-gradient(135deg,#58a6ff,#388bfd);color:#fff;border:none;padding:14px 24px;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin:12px auto 10px;box-shadow:0 4px 20px rgba(88,166,255,.5);transition:all .3s;animation:rematchPulse 2s ease-in-out infinite}
.btn-rematch:hover{box-shadow:0 6px 30px rgba(88,166,255,.8);transform:translateY(-3px) scale(1.05)}
@keyframes rematchPulse{0%,100%{box-shadow:0 4px 20px rgba(88,166,255,.5)}50%{box-shadow:0 6px 30px rgba(88,166,255,.8)}}
</style>
</head>
<body>

<!-- LOBBY -->
<div id="lobby" class="screen on">
  <div class="card">
    <div class="emoji">ğŸ±</div>
    <h1>å›´ä½ç¥ç»å–µ</h1>
    <p class="sub">åŒäººè”æœº Â· PeerJS P2P Â· å¯éƒ¨ç½² GitHub Pages</p>

    <button id="createBtn" class="btn btn-red" onclick="createRoom()">ğŸ® åˆ›å»ºæˆ¿é—´ï¼ˆæˆ‘æ˜¯çŒ«å’ª1 ğŸ±ï¼‰</button>

    <div id="waitBox">
      <div class="wt">âœ… æˆ¿é—´å·²åˆ›å»ºï¼Œå°†ä»¥ä¸‹å·ç åˆ†äº«ç»™æœ‹å‹</div>
      <div id="waitCode"></div>
      <small>å¯¹æ–¹è¾“å…¥æˆ¿é—´å·åŠ å…¥åï¼Œæ¸¸æˆè‡ªåŠ¨å¼€å§‹</small>
    </div>

    <div class="join-row">
      <input id="codeIn" placeholder="è¾“å…¥æˆ¿é—´å·" maxlength="6"
             oninput="this.value=this.value.toUpperCase()"
             onkeydown="if(event.key==='Enter')joinRoom()"/>
      <button class="btn-grn" onclick="joinRoom()">åŠ å…¥</button>
    </div>

    <div id="errMsg" class="err"></div>
    <div id="infoMsg" class="info"></div>

    <div class="rules">
      <b class="t">ğŸ“– æ¸¸æˆè§„åˆ™</b>
      <p>ğŸ± <b style="color:#f0883e">çŒ«å’ª1</b>ï¼ˆæ©™è‰²ï¼‰ï¼šèµ·å§‹é¡¶éƒ¨ï¼Œç›®æ ‡åˆ°è¾¾åº•éƒ¨è¾¹ç¼˜<br>
         ğŸ˜º <b style="color:#58a6ff">çŒ«å’ª2</b>ï¼ˆè“è‰²ï¼‰ï¼šèµ·å§‹åº•éƒ¨ï¼Œç›®æ ‡åˆ°è¾¾é¡¶éƒ¨è¾¹ç¼˜<br>
         æ¯å›åˆå¯é€‰æ‹©ï¼š<b>ç§»åŠ¨è‡ªå·±çš„çŒ«</b> æˆ– <b>ç»™å¯¹æ–¹æ”¾éšœç¢</b><br>
         âš ï¸ æ”¾ç½®éšœç¢æ—¶ï¼Œå¿…é¡»ä¿è¯å¯¹æ–¹ä»æœ‰è·¯å¾„åˆ°è¾¾ç›®æ ‡è¾¹ç¼˜<br>
         å…ˆåˆ°è¾¾å¯¹é¢è¾¹ç¼˜çš„çŒ«è·èƒœï¼çŒ«å’ª1å…ˆæ‰‹ã€‚</p>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="game" class="screen">
  <div class="ghdr">
    <div class="ghdr-info">
      <h2>ğŸ± å›´ä½ç¥ç»å–µ</h2>
      <p>æˆ¿é—´ <span id="roomTxt" style="color:#58a6ff;font-weight:700"></span>
         &nbsp;æˆ‘æ˜¯ <span id="roleTxt"></span>
         <span id="badge" class="badge b-wait">ç­‰å¾…ä¸­</span></p>
    </div>
    <button class="btn-sm btn-home" onclick="goHome()">â† é€€å‡º</button>
  </div>
  <div class="sbar"><p id="stTxt" style="color:#7d8590"><span class="spin"></span>è¿æ¥ä¸­â€¦</p></div>
  <button id="rstBtn" class="btn-rematch" onclick="resetGame()" style="display:none;max-width:440px;width:100%">ğŸ”„ å†æ¥ä¸€å±€</button>
  <div id="actionBtns" class="action-btns">
    <button id="moveBtn" class="btn-action" onclick="setActionMode('move')">ğŸ¾ ç§»åŠ¨çŒ«å’ª</button>
    <button id="blockBtn" class="btn-action" onclick="setActionMode('block')">ğŸš§ æ”¾ç½®éšœç¢</button>
  </div>
  <div id="board"></div>
  <div class="legend">
    <span class="ld"><span class="ldot cat1"></span>çŒ«å’ª1ğŸ±ï¼ˆæ©™ï¼‰</span>
    <span class="ld"><span class="ldot cat2"></span>çŒ«å’ª2ğŸ˜ºï¼ˆè“ï¼‰</span>
    <span class="ld"><span class="ldot" style="background:#6e1a1a;border:1px solid #da3633"></span>éšœç¢</span>
    <span class="ld"><span class="ldot" style="background:#0d2818;border:2px solid #3fb950"></span>å¯ç§»åŠ¨</span>
    <span class="ld"><span class="ldot" style="background:#2d1f10;border:2px solid #f0883e"></span>å¯æ”¾éšœç¢</span>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const N=9, CS=34, GAP=4, STEP=CS+GAP, RH=30;
const PEER_CFG = {
  host: '0.peerjs.com', port: 443, path: '/', secure: true,
  config: {iceServers:[
    {urls:'stun:stun.l.google.com:19302'},
    {urls:'stun:stun1.l.google.com:19302'}
  ]}
};

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let peer=null, conn=null, myRole=null, roomCode=null, gs=null;
let linked=false, joinTimeout=null, retryCount=0;
let currentActionMode=null;

// â”€â”€ Hex helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const nbrs=(r,c)=>r%2===0
  ?[[r-1,c-1],[r-1,c],[r,c-1],[r,c+1],[r+1,c-1],[r+1,c]]
  :[[r-1,c],[r-1,c+1],[r,c-1],[r,c+1],[r+1,c],[r+1,c+1]];
const inB=(r,c)=>r>=0&&r<N&&c>=0&&c<N;
const isEdge=(r,c)=>r===0||r===N-1||c===0||c===N-1;
const vMoves=(b,r,c)=>nbrs(r,c).filter(([nr,nc])=>inB(nr,nc)&&b[nr][nc]===0);
const surrounded=(b,r,c)=>vMoves(b,r,c).length===0;

// â”€â”€ BFS Path Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hasPathToGoal(board, sr, sc, goalCheck) {
  const visited = Array(N).fill(null).map(() => Array(N).fill(false));
  const queue = [[sr, sc]];
  visited[sr][sc] = true;

  while(queue.length > 0) {
    const [r, c] = queue.shift();
    if(goalCheck(r, c)) return true;

    for(const [nr, nc] of nbrs(r, c)) {
      if(inB(nr, nc) && !visited[nr][nc] && board[nr][nc] === 0) {
        visited[nr][nc] = true;
        queue.push([nr, nc]);
      }
    }
  }
  return false;
}

function canCat1Reach(board, cat1r, cat1c) {
  return hasPathToGoal(board, cat1r, cat1c, (r, c) => r === N - 1);
}

function canCat2Reach(board, cat2r, cat2c) {
  return hasPathToGoal(board, cat2r, cat2c, (r, c) => r === 0);
}

function isValidBlock(board, cats, blockR, blockC, currentPlayer) {
  if((cats.cat1.r === blockR && cats.cat1.c === blockC) ||
     (cats.cat2.r === blockR && cats.cat2.c === blockC)) {
    return false;
  }

  const testBoard = board.map(row => [...row]);
  testBoard[blockR][blockC] = 1;

  const opponent = currentPlayer === 'cat1' ? 'cat2' : 'cat1';
  if(opponent === 'cat1') {
    return canCat1Reach(testBoard, cats.cat1.r, cats.cat1.c);
  } else {
    return canCat2Reach(testBoard, cats.cat2.r, cats.cat2.c);
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id){return document.getElementById(id);}
function setErr(m){$('errMsg').textContent=m;}
function setInfo(m){$('infoMsg').textContent=m;}
function st(t,c){const e=$('stTxt');e.innerHTML=t;e.style.color=c||'#e6edf3';}
function badge(s){ // 'on'|'off'|'wait'
  const e=$('badge');
  if(s==='on'){e.textContent='å·²è¿æ¥';e.className='badge b-on';}
  else if(s==='off'){e.textContent='å·²æ–­å¼€';e.className='badge b-off';}
  else{e.textContent='ç­‰å¾…ä¸­';e.className='badge b-wait';}
}
function randCode(){
  const a='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s='';for(let i=0;i<6;i++)s+=a[Math.floor(Math.random()*a.length)];return s;
}

// â”€â”€ Game state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkState(){
  const b=Array(N).fill(null).map(()=>Array(N).fill(0));
  let n=0;
  while(n<3){
    const r=Math.floor(Math.random()*N),c=Math.floor(Math.random()*N);
    if(!b[r][c]&&r!==0&&r!==N-1&&c!==4){b[r][c]=1;n++;}
  }
  return{board:b,cats:{cat1:{r:0,c:4},cat2:{r:8,c:4}},turn:'cat1',winner:null};
}

// â”€â”€ Send / Receive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function send(type, data){
  if(conn&&conn.open) conn.send(JSON.stringify({type,data}));
}

function onData(raw){
  let m;
  try{m=typeof raw==='string'?JSON.parse(raw):raw;}catch{return;}
  if(m.type==='state'){
    gs=m.data; render(); syncStatus();
  } else if(m.type==='action'){
    if(m.data.player===myRole) return;
    if(m.data.type==='move'){
      applyMove(m.data.player,m.data.r,m.data.c);
    } else if(m.data.type==='block'){
      applyBlock(m.data.player,m.data.r,m.data.c);
    }
  } else if(m.type==='reset'){
    gs=m.data; currentActionMode=null; render(); syncStatus();
  }
}

function wireConn(c){
  conn=c;
  conn.on('open',()=>{
    clearTimeout(joinTimeout);
    linked=true; badge('on');
    if(myRole==='cat1'){
      gs=mkState(); send('state',gs); render(); syncStatus();
    }
  });
  conn.on('data',onData);
  conn.on('close',()=>{
    linked=false; badge('off');
    if(gs&&!gs.winner) st('âš ï¸ å¯¹æ‰‹æ–­çº¿äº†â€¦','#f85149');
  });
  conn.on('error',(e)=>{
    linked=false; badge('off');
    st('âš ï¸ è¿æ¥é”™è¯¯: '+(e.message||e.type||e),'#f85149');
  });
}

// â”€â”€ Create room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createRoom(){
  setErr(''); setInfo(''); $('createBtn').disabled=true;
  setInfo('æ­£åœ¨è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨â€¦');
  destroyPeer();
  const code=randCode();
  roomCode=code; myRole='cat1';

  peer=new Peer('nc-'+code, PEER_CFG);

  peer.on('open',()=>{
    setInfo('');
    $('waitCode').textContent=code;
    $('waitBox').style.display='block';
    $('createBtn').style.display='none';
    showGame();
    st('<span class="spin"></span>ç­‰å¾…å¯¹æ‰‹åŠ å…¥â€¦ æˆ¿é—´å·: '+code,'#f0883e');
  });

  peer.on('connection',c=>{ wireConn(c); });

  peer.on('error',e=>{
    $('createBtn').disabled=false;
    const msg=e.message||e.type||String(e);
    if(e.type==='unavailable-id'){
      setInfo('æˆ¿é—´å·å†²çªï¼Œæ­£åœ¨é‡è¯•â€¦');
      retryCount++;
      if(retryCount<5){ setTimeout(createRoom,500); }
      else { retryCount=0; setErr('å¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢å†è¯•'); setInfo(''); }
    } else {
      setErr('åˆ›å»ºå¤±è´¥: '+msg);
      setInfo('æç¤ºï¼šå¦‚åœ¨æœ¬é¡µé¢æµ‹è¯•ï¼Œä¿¡ä»¤æœåŠ¡å™¨å¯èƒ½å—é™ï¼Œè¯·éƒ¨ç½²åˆ° GitHub Pages åå†è¯•');
    }
  });
}

// â”€â”€ Join room â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function joinRoom(){
  const code=$('codeIn').value.trim().toUpperCase();
  if(code.length<4){setErr('è¯·è¾“å…¥æˆ¿é—´å·ï¼ˆ4-6ä½ï¼‰');return;}
  setErr(''); setInfo('æ­£åœ¨è¿æ¥ä¿¡ä»¤æœåŠ¡å™¨â€¦');
  destroyPeer();
  myRole='cat2'; roomCode=code;

  peer=new Peer(PEER_CFG);

  peer.on('open',()=>{
    setInfo('æ­£åœ¨è¿æ¥çŒ«å’ª1â€¦');
    conn=peer.connect('nc-'+code,{reliable:true,serialization:'json'});
    wireConn(conn);
    showGame();
    st('<span class="spin"></span>æ­£åœ¨è¿æ¥æˆ¿é—´ '+code+'â€¦','#f0883e');

    // 30s timeout
    joinTimeout=setTimeout(()=>{
      if(!linked){
        st('âš ï¸ è¿æ¥è¶…æ—¶ï¼Œè¯·ç¡®è®¤æˆ¿é—´å·æ˜¯å¦æ­£ç¡®','#f85149');
        badge('off');
      }
    },30000);
  });

  peer.on('error',e=>{
    const msg=e.message||e.type||String(e);
    if(e.type==='peer-unavailable'){
      st('âš ï¸ æ‰¾ä¸åˆ°è¯¥æˆ¿é—´ï¼Œè¯·ç¡®è®¤æˆ¿é—´å·','#f85149');
      setErr('æˆ¿é—´ä¸å­˜åœ¨æˆ–å·²å…³é—­');
      goHome();
    } else {
      st('âš ï¸ é”™è¯¯: '+msg,'#f85149');
      setErr('è¿æ¥å¤±è´¥: '+msg+'\næç¤ºï¼šè¯·éƒ¨ç½²åˆ° GitHub Pages åå†å°è¯•è”æœº');
    }
  });
}

// â”€â”€ Game logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setActionMode(mode){
  if(!gs||gs.winner||!linked||gs.turn!==myRole) return;
  currentActionMode=mode;
  render();
}

function handleClick(r,c){
  if(!gs||gs.winner||!linked||gs.turn!==myRole) return;

  if(!currentActionMode){
    st('âš ï¸ è¯·å…ˆé€‰æ‹©è¡ŒåŠ¨ï¼šç§»åŠ¨çŒ«å’ª æˆ– æ”¾ç½®éšœç¢','#f0883e');
    return;
  }

  const myCat=gs.cats[myRole];

  if(currentActionMode==='move'){
    const vm=vMoves(gs.board,myCat.r,myCat.c);
    if(!vm.some(([nr,nc])=>nr===r&&nc===c)) return;
    send('action',{type:'move',player:myRole,r,c});
    applyMove(myRole,r,c);
  } else if(currentActionMode==='block'){
    if(gs.board[r][c]===1) return;
    if((gs.cats.cat1.r===r&&gs.cats.cat1.c===c)||
       (gs.cats.cat2.r===r&&gs.cats.cat2.c===c)){
      st('âš ï¸ ä¸èƒ½åœ¨çŒ«çš„ä½ç½®æ”¾ç½®éšœç¢','#f85149');
      return;
    }
    if(!isValidBlock(gs.board,gs.cats,r,c,myRole)){
      st('âš ï¸ è¯¥éšœç¢ä¼šå µæ­»å¯¹æ–¹æ‰€æœ‰è·¯å¾„ï¼Œè¯·é€‰æ‹©å…¶ä»–ä½ç½®','#f85149');
      return;
    }
    send('action',{type:'block',player:myRole,r,c});
    applyBlock(myRole,r,c);
  }

  currentActionMode=null;
}

function applyMove(player,r,c){
  const newCats={...gs.cats};
  newCats[player]={r,c};

  let winner=null;
  if(player==='cat1'&&r===N-1) winner='cat1';
  if(player==='cat2'&&r===0) winner='cat2';

  const nextTurn=winner?player:(player==='cat1'?'cat2':'cat1');

  gs={...gs,cats:newCats,turn:nextTurn,winner};
  send('state',gs); render();

  if(winner) triggerVictory(winner);

  syncStatus();
}

function applyBlock(player,r,c){
  const newBoard=gs.board.map(row=>[...row]);
  newBoard[r][c]=1;

  const nextTurn=player==='cat1'?'cat2':'cat1';

  gs={...gs,board:newBoard,turn:nextTurn};
  send('state',gs); render(); syncStatus();
}

function resetGame(){
  if(myRole!=='cat1') return;
  gs=mkState();
  currentActionMode=null;
  send('reset',gs);
  $('rstBtn').style.display='none';
  render();
  syncStatus();
  st('ğŸ® æ–°æ¸¸æˆå¼€å§‹ï¼çŒ«å’ª1å…ˆæ‰‹','#58a6ff');
}

// â”€â”€ Victory Effects â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerVictory(winner){
  if(winner!==myRole) return;
  setTimeout(()=>{
    for(let i=0;i<50;i++){
      setTimeout(()=>createConfetti(),i*30);
    }
  },200);
}

function createConfetti(){
  const colors=['#f0883e','#58a6ff','#3fb950','#da3633','#f0d83e','#bc4aff'];
  const confetti=document.createElement('div');
  confetti.style.cssText=`
    position:fixed;
    width:${Math.random()*10+5}px;
    height:${Math.random()*10+5}px;
    background:${colors[Math.floor(Math.random()*colors.length)]};
    left:${Math.random()*100}vw;
    top:-10px;
    border-radius:${Math.random()>0.5?'50%':'0'};
    z-index:9999;
    pointer-events:none;
    animation:confettiFall ${Math.random()*2+2}s linear forwards;
    transform:rotate(${Math.random()*360}deg);
  `;
  document.body.appendChild(confetti);
  setTimeout(()=>confetti.remove(),5000);
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
  if(!gs||!gs.board) return;
  const{board,cats,turn,winner}=gs;

  const myCat=cats[myRole];
  let highlightCells=[];
  if(!winner&&turn===myRole&&linked){
    if(currentActionMode==='move'){
      highlightCells=vMoves(board,myCat.r,myCat.c);
    } else if(currentActionMode==='block'){
      for(let r=0;r<N;r++){
        for(let c=0;c<N;c++){
          if(board[r][c]===0&&
             !(cats.cat1.r===r&&cats.cat1.c===c)&&
             !(cats.cat2.r===r&&cats.cat2.c===c)){
            highlightCells.push([r,c]);
          }
        }
      }
    }
  }

  const wrap=$('board');
  wrap.style.cssText=`position:relative;width:${N*STEP+STEP/2}px;height:${(N-1)*RH+CS}px`;
  let html='';
  for(let r=0;r<N;r++){
    const ox=r%2?STEP/2:0;
    for(let c=0;c<N;c++){
      const x=ox+c*STEP, y=r*RH;
      const isCat1=cats.cat1.r===r&&cats.cat1.c===c;
      const isCat2=cats.cat2.r===r&&cats.cat2.c===c;
      const isBlk=board[r][c]===1;
      const isHL=highlightCells.some(([nr,nc])=>nr===r&&nc===c);
      let cls='cell ';
      let emoji='';

      if(isCat1){
        cls+='cat cat1';
        emoji='ğŸ±';
      } else if(isCat2){
        cls+='cat cat2';
        emoji='ğŸ˜º';
      } else if(isBlk){
        cls+='blk';
      } else if(isHL){
        cls+=currentActionMode==='move'?'vm':'vb';
      } else if(isEdge(r,c)){
        cls+='edge';
      } else {
        cls+='empty';
      }

      const clickable=!winner&&turn===myRole&&linked&&isHL;
      if(clickable)cls+=' clk';

      const oc=clickable?`onclick="handleClick(${r},${c})"`:'';
      html+=`<div class="${cls}" style="left:${x}px;top:${y}px;width:${CS}px;height:${CS}px" ${oc}>${emoji}</div>`;
    }
  }
  wrap.innerHTML=html;

  updateActionButtons();

  if(winner&&myRole==='cat1'){
    $('rstBtn').style.display='block';
  } else {
    $('rstBtn').style.display='none';
  }
}

function updateActionButtons(){
  const moveBtn=$('moveBtn');
  const blockBtn=$('blockBtn');

  if(!gs||gs.winner||!linked||gs.turn!==myRole){
    moveBtn.disabled=true;
    blockBtn.disabled=true;
    moveBtn.classList.remove('active');
    blockBtn.classList.remove('active');
    return;
  }

  moveBtn.disabled=false;
  blockBtn.disabled=false;

  if(currentActionMode==='move'){
    moveBtn.classList.add('active');
    blockBtn.classList.remove('active');
  } else if(currentActionMode==='block'){
    moveBtn.classList.remove('active');
    blockBtn.classList.add('active');
  } else {
    moveBtn.classList.remove('active');
    blockBtn.classList.remove('active');
  }
}

function syncStatus(){
  if(!gs) return;
  const{turn,winner}=gs;
  if(winner){
    const win=winner===myRole;
    const goalText=winner==='cat1'?'åˆ°è¾¾åº•éƒ¨':'åˆ°è¾¾é¡¶éƒ¨';
    st(win?`ğŸ‰ æ­å–œï¼ä½ çš„çŒ«å’ª${goalText}ï¼Œä½ èµ¢äº†ï¼`
          :`ğŸ˜¿ å¯¹æ‰‹çš„çŒ«å’ª${goalText}ï¼Œä½ è¾“äº†â€¦`,
       win?'#3fb950':'#f85149');
    return;
  }
  if(turn===myRole){
    if(!currentActionMode){
      st('âœ¨ ä½ çš„å›åˆï¼è¯·é€‰æ‹©è¡ŒåŠ¨ï¼šç§»åŠ¨çŒ«å’ª æˆ– æ”¾ç½®éšœç¢','#58a6ff');
    } else if(currentActionMode==='move'){
      st('âœ¨ ç§»åŠ¨æ¨¡å¼ï¼šç‚¹å‡»ç»¿è‰²æ ¼å­ç§»åŠ¨ä½ çš„çŒ«å’ª','#3fb950');
    } else {
      st('âœ¨ éšœç¢æ¨¡å¼ï¼šç‚¹å‡»ç©ºæ ¼æ”¾ç½®éšœç¢ï¼ˆä¸èƒ½å µæ­»å¯¹æ–¹æ‰€æœ‰è·¯å¾„ï¼‰','#f0883e');
    }
  } else {
    st(`â³ ç­‰å¾…å¯¹æ‰‹è¡ŒåŠ¨â€¦`,'#7d8590');
  }
}

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showGame(){
  $('lobby').classList.remove('on');
  $('game').classList.add('on');
  $('roomTxt').textContent=roomCode;
  $('roleTxt').innerHTML=myRole==='cat1'
    ?'<span style="color:#f0883e;font-weight:700">ğŸ± çŒ«å’ª1</span>'
    :'<span style="color:#58a6ff;font-weight:700">ğŸ˜º çŒ«å’ª2</span>';
}

function goHome(){
  clearTimeout(joinTimeout);
  destroyPeer();
  gs=null; myRole=null; roomCode=null; linked=false; retryCount=0; currentActionMode=null;
  $('game').classList.remove('on'); $('lobby').classList.add('on');
  $('waitBox').style.display='none'; $('createBtn').style.display='';
  $('createBtn').disabled=false; $('codeIn').value='';
  $('rstBtn').style.display='none';
  setErr(''); setInfo('');
}

function destroyPeer(){
  if(peer){try{peer.destroy();}catch{}peer=null;}
  conn=null; linked=false; badge('wait');
}
</script>
</body>
</html>
